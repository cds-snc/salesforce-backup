name: Salesforce Backup
on:
  workflow_dispatch:
  schedule:
    - cron: "0 6 * * *"

permissions:
  id-token: write
  contents: read
  pull-requests: write
  actions: write
  checks: write
  statuses: write

env:
  LOG_LEVEL: "WARN"
  POWERTOOL_SERVICE_NAME: "GHAction"
  SalesforceConsumerKey: ${{ secrets.SALESFORCE_CONSUMER_KEY }}
  SalesforceConsumerSecret: ${{ secrets.SALESFORCE_CONSUMER_SECRET }}
  SalesforcePass: ${{ secrets.SALESFORCE_PASSWORD }}
  SalesforceSecurityToken: ${{ secrets.SALESFORCE_SECURITY_TOKEN }}
  SalesforceUser: ${{ secrets.SALESFORCE_USER }}
  SALESFORCE_TIMEOUT_SECONDS: 30

jobs:
  s3-backup:
    runs-on: ubuntu-latest
    steps:

    - name: Checkout
      uses: actions/checkout@c85c95e3d7251135ab7dc9ce3241c5835cc595a9 # v3.5.3

    - name: configure aws credentials using OIDC
      uses: aws-actions/configure-aws-credentials@5fd3084fc36e372ff1fff382a39b10d03659f355 # v2.2.0
      with:
        role-to-assume: arn:aws:iam::563894450011:role/salesforce-backup
        role-session-name: salesforce-backup
        aws-region: ca-central-1

    - uses: actions/setup-python@61a6322f88396a6271a6ee3565807d608ecaddd1 # v4.7.0
      with:
        python-version: '3.11'

    - name: install dependencies
      run: make requirements

    - name: pull down file
      run: make run-local

    - name: Upload to S3 bucket
      run: |
        aws s3 sync ./csv s3://cds-salesforce-backups